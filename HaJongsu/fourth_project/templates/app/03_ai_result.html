<!-- c:/Workspaces/Personal_Anything/3rd_to_4th/fourth_project/templates/app/03_ai_result.html -->

{% extends "layout/base.html" %}
{% load static %}
{% block title %}AI 첨삭 결과{% endblock title %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">

        <!-- 왼쪽 컬럼 (8칸): 첨삭 결과 -->
        <div class="col-lg-8">
            <h2 class="mb-4">🤖 AI 멘토 첨삭 결과</h2>
    
            <!-- 학생 답안 / 모범 답안 -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-info-subtle"><strong>👨‍🎓 학생 답안 (OCR 변환)</strong></div>
                        <div class="card-body"><textarea class="form-control answer-textarea" readonly>{{ student_answer }}</textarea></div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-warning-subtle"><strong>✅ 모범 답안</strong></div>
                        <div class="card-body"><textarea class="form-control answer-textarea" readonly>{{ model_answer }}</textarea></div>
                    </div>
                </div>
            </div>
            
            <!-- AI 코멘트 카드 -->
            <div class="card mt-4">
                <div class="card-header"><strong>✨ 논리왕 김멘토's 코멘트</strong></div>
                <div class="card-body">
                    {{ main_comment_html|safe }}
                    {% if suggestions %}
                        <h4 class="mt-4">💡 이렇게 바꿔보세요</h4>
                        <div class="accordion" id="suggestionAccordion">
                            {% for item in suggestions %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                                        <strong>수정 제안 #{{ forloop.counter }}:</strong>  "{{ item.original|truncatechars:50 }}"
                                    </button>
                                </h2>
                                <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <p class="text-muted"><strong>학생 원문:</strong> "{{ item.original }}"</p>
                                        <p><strong>수정 제안:</strong> "{{ item.diff_html|safe }}"</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if final_comment_html %}
                        <div class="p-3 bg-light rounded mt-4">
                            {{ final_comment_html|safe }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 오른쪽 컬럼 (4칸): 채팅창 -->
        <div class="col-lg-4">
            <!-- ★★★ 채팅창을 감싸는 div에 id를 부여해서 CSS로 제어할 거야! ★★★ -->
            <div id="fixed-chat-container">
                <div class="card">
                    <div class="card-header"><strong><i class="bi bi-chat-dots-fill"></i>AI 챗봇</strong></div>
                    <div class="card-body d-flex flex-column p-2">
                        <!-- 채팅 메시지가 표시될 영역 -->
                        <div id="chat-history" class="flex-grow-1 p-2" style="overflow-y: auto;">
                            <div class="chat-message ai-message">
                                첨삭 결과에 대해 궁금한 점을 질문해보세요!
                            </div>
                        </div>
                        <!-- 메시지 입력 폼 -->
                        <form id="chat-form" class="mt-auto p-2 d-flex" data-submission-id="{{ submission.id }}">
                            {% csrf_token %}
                            <input type="text" id="chat-input" class="form-control" placeholder="메시지를 입력하세요..." autocomplete="off" required>
                            <button type="submit" class="btn btn-primary ms-2"><i class="bi bi-arrow-up"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

<!-- ★★★ 바로 여기가 새로 추가/수정될 부분! ★★★ -->
{% block script %}
<script src="{% static 'js/chat.js' %}"></script>
{% endblock script %}