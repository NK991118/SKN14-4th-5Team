{% extends 'layout/base.html' %}
{% load static %}

{% block title %}AI 논술 첨삭 - 답안 채점{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/grading.css' %}">
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <aside class="col-lg-3 p-4 bg-light">
                <div class="sidebar-header d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h4 mb-0">✏️ AI 첨삭 챗봇</h1>
                    <a href="{% url 'app:index' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-house-door-fill"></i> 홈으로
                    </a>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">📁 파일 업로드</h5>
                        <input class="form-control" type="file" id="fileUploader" accept=".jpg, .jpeg, .png" multiple>
                        <div id="uploadedFileList" class="mt-3">
                            <p class="text-muted small">이미지 파일을 업로드해주세요.</p>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="col-lg-9 p-4">
                <h2 class="mb-4">🤖 GPT 기반 손글씨 첨삭</h2>

                <section id="previewSection" class="mb-4">
                    <h3 class="h5 mb-3">📸 선택한 답안지 미리보기 (가로 슬라이드)</h3>
                    <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner text-center bg-secondary-subtle rounded p-3">
                            <div class="carousel-item active">
                                <p class="d-block w-100 m-5">사이드바에서 파일을 업로드하고 목록에서 확인할 파일을 선택하세요.</p>
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button id="startGradingBtn" class="btn btn-primary btn-lg" type="button" disabled>
                            <i class="bi bi-robot"></i> GPT 첨삭 실행
                        </button>
                    </div>
                </section>

                <section id="resultSection" class="d-none">
                    <hr class="my-4">
                    <h3 class="h5 mb-3">📄 첨삭 결과</h3>
                    <div id="loadingSpinner" class="text-center my-5 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">AI 멘토가 답안을 분석하고 있습니다. 잠시만 기다려주세요...</p>
                    </div>

                    <div id="gradingResultContainer">
                        <!-- OCR 결과 표시 영역 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <strong>OCR 추출 텍스트:</strong>
                            </div>
                            <div class="card-body">
                                <pre><code id="ocrTextOutput"></code></pre>
                            </div>
                        </div>

                        <h4 class="h6 mb-3">AI 멘토 첨삭 결과</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info-subtle">👨‍🎓 학생 답안 (OCR 변환)</div>
                                    <div class="card-body">
                                        <textarea id="studentAnswer" class="form-control" rows="15" readonly></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-warning-subtle">✅ 모범 답안</div>
                                    <div class="card-body">
                                        <textarea id="modelAnswer" class="form-control" rows="15" readonly></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="aiComments" class="mt-4">
                        </div>
                    </div>
                </section>

                <section id="chatbotSection" class="mt-4">
                    <hr class="my-4">
                    <h3 class="h5 mb-3">💬 내 답변 기반 Q&A 챗봇</h3>

                    <div class="faq-buttons mb-3">
                        <p class="fw-bold small">📌 자주 묻는 질문</p>
                        <button class="btn btn-outline-secondary btn-sm mb-1">내 주장의 논리 전개가 괜찮은가요?</button>
                        <button class="btn btn-outline-secondary btn-sm mb-1">더 설득력 있게 쓰려면 어떤 표현을 쓰면 좋을까요?</button>
                        <button class="btn btn-outline-secondary btn-sm mb-1">결론 부분을 어떻게 보완할 수 있을까요?</button>
                        <button class="btn btn-outline-secondary btn-sm mb-1">예시가 부족한가요?</button>
                    </div>

                    <div id="chatHistory" class="chat-history border rounded p-3 mb-3" style="height: 300px; overflow-y: auto;">

                        <div class="text-muted text-center">궁금한 점을 질문하거나 자주 묻는 질문을 클릭해보세요.</div>
                    </div>

                    <form id="chatForm" class="d-flex">
                        <input type="text" id="chatInput" class="form-control me-2" placeholder="질문을 입력하세요..." autocomplete="off">
                        <button class="btn btn-success" type="submit">전송</button>
                    </form>
                </section>
            </main>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/grading.js' %}"></script>
    <script src="{% static 'js/fileUploader.js' %}"></script>
{% endblock %}